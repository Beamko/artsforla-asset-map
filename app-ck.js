/*global require, L, cartodb*/require(["lodash","jquery","bootstrap-amd","chosen-js","geojson/blueLine","geojson/expoLine","geojson/goldLine","geojson/greenLine","geojson/redLine"],function(e,t){function o(e,n){var r=[],i=t.isEmptyObject(e)?"SELECT * FROM "+tableName:"SELECT * FROM "+tableName+" WHERE ",s=t.isEmptyObject(e)?" WHERE ":" AND ";if(Object.keys(e).length)for(var o in e)e.hasOwnProperty(o)&&r.push(e[o]);if(r.length)for(var a=0;a<r.length;a++)a<r.length-1?i+=r[a]+" AND ":i+=r[a];console.log(i);n.setQuery(i);u(i,s)}function u(e,n){t.ajax({url:"http://cs-chris.cartodb.com/api/v2/sql",type:"GET",dataType:"json",data:{q:e+n+"the_geom IS NOT NULL"}}).done(function(e){i.html("SHOWING "+e.total_rows+" ORGANIZATIONS")}).fail(function(e){console.log("error",e)})}function a(){t('input[type="checkbox"]:checked').attr("checked",!1);t("a.chosen-single>span").html("Any");t(".js-childFilter").addClass("u-isHiddenVisually")}function f(i){var u=[],f;s.click(function(){filters={};a();o(filters,i)});n.click(function(e){var t="";if(e.currentTarget.checked)u.push(e.currentTarget.value);else{var n=u.indexOf(e.currentTarget.value);u.splice(n,1)}if(u.length){var r="disciplines ILIKE ANY (ARRAY[ ";for(var s=0;s<u.length;s++){r+="'%"+u[s]+"%'";s<u.length-1&&(r+=",");t=t+" "+u[s]}r+="])";filters.discipline=r}else delete filters.discipline;o(filters,i)});t(".js-selectFilter").change(function(){var e=t("option:selected",this)[0].dataset;t(this).siblings(".js-childFilter").addClass("u-isHiddenVisually");"target"in e&&t("."+e.target).removeClass("u-isHiddenVisually");var n=this.dataset.column,r=f=t("option:selected",this).val();r!=="Any"?filters[n]=n+" ILIKE '%"+r+"%'":delete filters[n];o(filters,i)});t(".js-childFilter").change(function(){var e=this.dataset.column,n=t("option:selected",this).val();n!=="Any"?filters[e]=e+" ILIKE '%"+n+"%'":f!=="Any"?filters[e]=e+" ILIKE '%"+f+"%'":delete filters[e];o(filters,i)});r.change(function(){var n=t("option:selected",this)[0].dataset;t(".js-metroChildFilter").addClass("u-isHiddenVisually");"target"in n&&t("."+n.target).removeClass("u-isHiddenVisually");var r="http://a.tiles.mapbox.com/v3/civservchris.metroLines/{z}/{x}/{y}.png";"mblayer"in n&&(r="http://a.tiles.mapbox.com/v3/civservchris."+n.mblayer+"/{z}/{x}/{y}.png");c.setUrl(r);"station"in filters&&delete filters.station;var s=t("option:selected",this).val(),u="ST_Distance(the_geom::geography, ST_GeomFromText('LINESTRING(";if(s!=="Any"){e.forEach(self[s].features,function(e){u+=e.properties.POINT_X+" "+e.properties.POINT_Y+","});u=u.substr(0,u.length-1);u+=")', 4326)::geography) < 1609.344";SelectedLine=u;filters.line=u}else delete filters.line;o(filters,i)});t(".js-metroChildFilter").change(function(){"line"in filters&&delete filters.line;var n=this.dataset.line,r=t("option:selected",this).val(),s=e.find(self[n].features,{properties:{STATION:r}});if(r!=="Any")filters.station="ST_Distance(the_geom::geography, ST_PointFromText('POINT("+s.properties.POINT_X+" "+s.properties.POINT_Y+")', 4326)::geography) < 1609.344";else{delete filters.station;filters.line=SelectedLine}o(filters,i)})}var n=t(".checkbox input"),r=t("#rail-lines"),i=t(".search-results"),s=t(".reset-search-button");tableName="merge",cartoViz="http://cs-chris.cartodb.com/api/v2/viz/c34d4a60-1e6e-11e3-bc0f-f9e40de5c4b9/viz.json",filters={},SelectedLine="",self=this;var l=new L.Map("map",{center:[34.056,-118.235],zoom:11,zoomControl:!1});(new L.Control.Zoom({position:"bottomright"})).addTo(l);L.tileLayer("http://a.tiles.mapbox.com/v3/examples.map-zgrqqx0w/{z}/{x}/{y}.png",{attribution:"Mapbox"}).addTo(l);var c=L.tileLayer("http://a.tiles.mapbox.com/v3/civservchris.metroLines/{z}/{x}/{y}.png",{attribution:"Mapbox"});c.addTo(l);var h=cartodb.createLayer(l,cartoViz);h.addTo(l).on("done",function(e){var n=e.getSubLayer(0);n.infowindow.set("template",t("#infowindow_afla").html());n.on("featureClick",function(){t(".cartodb-infowindow").on("click",function(){})});f(e);u("SELECT * FROM "+tableName," WHERE ")});t(".legend-row").tooltip({selector:"a[data-toggle=tooltip]",trigger:"hover"});t(".chosen").chosen({disable_search:!0,inherit_select_classes:!0});t(".box-tab-toggle").click(function(){var e=t("."+this.dataset.target);if(e.hasClass("box-hidden")){e.removeClass("box-hidden");t(this).children(".ss-icon").text("remove")}else{e.addClass("box-hidden");t(this).children(".ss-icon").text("add")}})});